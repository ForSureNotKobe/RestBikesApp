@model Chat
@using Microsoft.AspNetCore.Identity
@inject UserManager<User> UserManager

<div class="chat-body" id="message-list">

    @foreach (var message in Model.Messages)
    {
        <div class="message">
            <div class="message-sender">@message.Name:</div>
            <div class="message-content">@message.Text</div>
            <div class="message-timestamp">@message.TImestamp</div>
        </div>
    }
</div>

<div>
    <footer>
        <div>
            <form onsubmit="sendMessage(event)" asp-controller="Chat" asp-action="CreateMessage">
                <input type="hidden" name="chatId" value="@Model.Id" />
                <input type="hidden" name="roomName" value="@Model.Name" />
                <input type="text" name="message" />
                <button id="sendButton" type="submit">Send!</button>
            </form>
        </div>
    </footer>
</div>

<script src="~/js/signalr/dist/browser/signalr.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>

    @*var usrName = @UserManager.FindByNameAsync(UserManager.GetUserName(User)).Result;*@

    var connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();

    const messages = document.getElementById('message-list');

    var _connectionId = '';

    connection.on("RecieveMessage", function (data) {
        console.log(data);

        var message = document.createElement("div")
        message.classList.add('message')

        var sender = document.createElement("div")
        sender.classList.add('message-sender')
        sender.appendChild(document.createTextNode(data.name + ":"))

        var content = document.createElement("div")
        content.classList.add('message-content')
        content.appendChild(document.createTextNode(data.text))

        var timestamp = document.createElement("div")
        timestamp.classList.add('message-timestamp')
        timestamp.appendChild(document.createTextNode(data.timestamp))

        message.appendChild(sender);
        message.appendChild(content);
        message.appendChild(timestamp);

        messages.append(message);

        //TODO: Get the recognition of user who is sending a message

        //console.log(usrName);

        //if (data.name == usrName) {
        //    messages.scrollTop = messages.scrollHeight;
        //}
    })

    var joinRoom = function () {
    var url = '/SignalR/JoinRoom/' + _connectionId + '/@Model.Name'
    axios.post(url, null)
        .then(res => {
            console.log("Room Joined!", res);
        })
        .catch(err => {
            console.err("Failed to join the room!", res);
        })
}

    connection.start()
        .then(function () {
            connection.invoke('getConnectionId')
                .then(function (connectionId) {
                    _connectionId = connectionId;
                    joinRoom();
                    messages.scrollTop = messages.scrollHeight;
                })
        })
        .catch(function (err) {
            console.log(err);
        })

    var sendMessage = function (event) {
        event.preventDefault();
        var data = new FormData(event.target);

        axios.post('/SignalR/SendMessage', data)
            .then(res => {
                console.log("Message sent!");
            })
            .catch(er => {
                console.log("Failed to send a message!");
            })
    }

</script>
